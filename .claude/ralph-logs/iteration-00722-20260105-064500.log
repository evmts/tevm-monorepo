# Ralph Migration Log - Iteration 722
## Date: 2026-01-05

## Task: Assess migration status and attempt test-matchers migration

## Assessment
The core packages (@tevm/actions, @tevm/vm, @tevm/evm, @tevm/state, @tevm/node) have been successfully migrated away from direct viem imports. The remaining viem imports are in:

1. **packages/memory-client/src/**: Intentional - this package provides viem Client compatibility
2. **packages/utils/src/viem.js**: Contains native implementations alongside deprecated viem re-exports
3. **packages/common/src/presets/**: Uses viem/chains for chain definitions (intentional)
4. **extensions/test-matchers/src/**: Mixed - some imports required for viem Client compatibility

## Attempted Migration
Tried to migrate `extensions/test-matchers/src/matchers/errors/handleTransaction.ts`:
- Moved `ContractFunctionRevertedError`, `decodeAbiParameters`, `Hex`, `isHex`, `AbiError` to `@tevm/utils`
- Problem: `TransactionReceipt` type conflict - @tevm/utils exports `RpcTransactionReceipt` (with Hex values) but viem's `TransactionReceipt` has decoded values (bigint)
- Problem: `DecodeErrorResultReturnType` not exported from @tevm/utils
- Reverted changes as the type incompatibilities were complex

## Key Findings
1. **TransactionReceipt type conflict**: @tevm/utils has `RpcTransactionReceipt` (hex strings for blockNumber etc.) but viem's `TransactionReceipt` has decoded values (bigint). These are incompatible.

2. **Missing from @tevm/utils**:
   - `DecodeErrorResultReturnType` - complex error decoding return type
   - Decoded `TransactionReceipt` (with bigint values, not hex strings)

3. **Core packages are clean**: @tevm/actions, @tevm/vm, @tevm/evm, @tevm/state, @tevm/node have no direct viem imports

4. **Intentional viem usage**:
   - `Client` type in test-matchers for API compatibility with viem clients
   - `waitForTransactionReceipt`, `estimateGas`, `getTransaction` viem/actions for client operations
   - Transport functions for RPC communication

## Files Already Well Migrated
- extensions/test-node/src/internal/*.ts - using @tevm/utils for types
- extensions/test-node/src/types.ts - using @tevm/utils
- extensions/test-matchers/src/matchers/balance/*.ts - only Client type from viem

## Next Steps
1. Consider adding `DecodeErrorResultReturnType` equivalent to @tevm/utils
2. Consider adding decoded `TransactionReceipt` type (with bigint values) to @tevm/utils  
3. Look at bundler-packages/mud for potential migrations
4. The remaining viem imports in test-matchers are mostly intentional for viem Client compatibility

## Migration Progress Summary
- Core packages: COMPLETE ✅
- @tevm/utils: Native implementations added, deprecated viem re-exports present
- extensions/test-node: Mostly migrated ✅
- extensions/test-matchers: Type imports partially migrated, runtime imports intentional

## Additional Attempts

### MUD Package Migration
Attempted to migrate `bundler-packages/mud/src/internal/decorators/mudStoreGetStorageAtOverride.ts`:
- Tried replacing `EIP1193RequestFn` from viem with @tevm/utils export
- **Failed**: Type incompatibility - viem's EIP1193RequestFn has different generic constraints than @tevm/utils version
- The types are structurally different and cause type errors when mixing
- Reverted changes

### Key Insight
The viem `EIP1193RequestFn` type is more specific with method/params unions, while @tevm/utils has a simpler generic version. These are not interchangeable without type assertions.

## Conclusion
Most remaining viem imports are either:
1. Intentional for viem Client compatibility
2. Type incompatibilities that require careful alignment work
3. viem/actions functions that need to work with viem clients

The easy migration targets have been completed. Future migration work should focus on:
1. Creating type-compatible versions of remaining viem types
2. Ensuring @tevm/utils exports are compatible with viem's type signatures
3. Being careful with EIP1193RequestFn type compatibility

## Final Summary

### Migration Status by Area

#### Core Packages (packages/*/src)
**36 viem import statements remaining**, but ALL are intentional:
- `packages/memory-client/`: 28 imports - INTENTIONAL (viem-compatible client package)
- `packages/utils/src/viem.js`: 2 imports - Deprecated re-exports, marked for removal
- `packages/common/src/`: 3 imports - Chain presets using viem/chains (intentional)
- `packages/utils/src/native*.js`: 3 imports - JSDoc examples comparing to viem

#### Extensions (extensions/*/src)
**35 viem import statements remaining**, mostly intentional:
- `extensions/viem/`: viem extension package (intentional)
- `extensions/test-matchers/`: `Client` type imports for API compatibility (intentional)
- `extensions/test-node/`: Minimal - mostly JSDoc examples

#### Bundler Packages (bundler-packages/*/src)
**11 viem import statements remaining**, intentional:
- `bundler-packages/mud/`: viem Client compatibility (intentional)
- `bundler-packages/whatsabi/`: viem chains and client for RPC (intentional)

### Conclusion
The migration is essentially **COMPLETE for core packages**. The remaining viem imports are:
1. **Intentional API compatibility** - packages designed to work with viem clients
2. **Deprecated re-exports** - marked for future removal in @tevm/utils  
3. **Documentation examples** - JSDoc showing comparison with viem APIs

No further viem migration is needed unless:
1. We want to completely eliminate viem as a dependency
2. We need to fix type incompatibilities (EIP1193RequestFn, TransactionReceipt)
3. We want to replace viem/chains with native chain definitions
