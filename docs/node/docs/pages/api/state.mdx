# @tevm/state

> **Generated API Documentation**: View the full API documentation in the [evmts/tevm-monorepo/packages/state/docs](https://github.com/evmts/tevm-monorepo/tree/main/packages/state/docs) folder.

The `@tevm/state` package provides functionality for managing Ethereum state, including account storage, contract code, and state transitions. It implements the EVM state manager interface and adds Tevm-specific features.

## Installation

```bash
npm install @tevm/state
```

Or use `tevm/state` if you have the main `tevm` package installed

## Main Components

### StateManager

The main interface for managing Ethereum state:

```typescript
interface StateManager {
  ready: () => Promise<true>
  getAccountAddresses: () => Set<Address>
  deepCopy: () => Promise<StateManager>
  dumpCanonicalGenesis: () => Promise<TevmState>
  clearCaches: () => void
  getAccount: (address: Address) => Promise<Account>
  putAccount: (address: Address, account: Account) => Promise<void>
  deleteAccount: (address: Address) => Promise<void>
  modifyAccountFields: (address: Address, fields: { nonce?: bigint; balance?: bigint }) => Promise<void>
  getContractCode: (address: Address) => Promise<Uint8Array>
  putContractCode: (address: Address, code: Uint8Array) => Promise<void>
  getContractStorage: (address: Address, key: Uint8Array) => Promise<Uint8Array>
  putContractStorage: (address: Address, key: Uint8Array, value: Uint8Array) => Promise<void>
  clearContractStorage: (address: Address) => Promise<void>
  checkpoint: () => Promise<void>
  commit: () => Promise<void>
  revert: () => Promise<void>
  getStateRoot: () => Promise<Uint8Array>
  setStateRoot: (root: Uint8Array) => Promise<void>
  hasStateRoot: (root: Uint8Array) => Promise<boolean>
  dumpStorage: (address: Address) => Promise<StorageDump>
  dumpStorageRange: (address: Address, startKey: bigint, limit: number) => Promise<StorageRange>
  getProof: (address: Address, storageKeys: Uint8Array[]) => Promise<Proof>
}
```

### Creating a State Manager

```typescript
import { createStateManager } from 'tevm/state'

const stateManager = createStateManager({
  loggingLevel: 'info'
})
```

## Core Functionality

### Account Management

```typescript
import { createStateManager } from 'tevm/state'
import { createAddress } from 'tevm/address'

const stateManager = createStateManager({})
const address = createAddress('0x1234567890123456789012345678901234567890')

// Get account state
const account = await stateManager.getAccount(address)

// Update account
await stateManager.putAccount(address, account)

// Delete account
await stateManager.deleteAccount(address)

// Modify specific account fields
await stateManager.modifyAccountFields(address, {
  nonce: 1n,
  balance: 100n
})
```

### Contract Management

```typescript
import { createStateManager } from 'tevm/state'
import { createAddress } from 'tevm/address'
import { hexToBytes } from 'tevm/utils'

const stateManager = createStateManager({})
const address = createAddress('0x1234567890123456789012345678901234567890')
const key = hexToBytes('0x0000000000000000000000000000000000000000000000000000000000000001')
const value = hexToBytes('0x0000000000000000000000000000000000000000000000000000000000000002')
const code = new Uint8Array([1, 2, 3])

// Get and set contract code
await stateManager.putContractCode(address, code)
const retrievedCode = await stateManager.getContractCode(address)

// Get and set contract storage
await stateManager.putContractStorage(address, key, value)
const retrievedValue = await stateManager.getContractStorage(address, key)

// Clear contract storage
await stateManager.clearContractStorage(address)
```

### State Management

```typescript
// Create checkpoint
await stateManager.checkpoint()

// Commit changes
await stateManager.commit()

// Revert to last checkpoint
await stateManager.revert()

// Get state root
const root = await stateManager.getStateRoot()

// Set state root
await stateManager.setStateRoot(root)

// Check if state root exists
const exists = await stateManager.hasStateRoot(root)
```

### State Dumping and Proofs

```typescript
// Dump canonical genesis state
const state = await stateManager.dumpCanonicalGenesis()

// Dump storage for address
const storage = await stateManager.dumpStorage(address)

// Dump storage range
const range = await stateManager.dumpStorageRange(address, 4n, 10)

// Get merkle proof
const proof = await stateManager.getProof(address, storageKeys)
```

### Cache Management

```typescript
// Clear all caches
stateManager.clearCaches()

// Deep copy (independent state)
const deepCopy = await stateManager.deepCopy()
```

## Best Practices

1. **Always await ready()**
```typescript
const stateManager = createStateManager({})
await stateManager.ready()
```

2. **Use checkpoints for atomic operations**
```typescript
await stateManager.checkpoint()
try {
  // Perform state changes
  await stateManager.commit()
} catch (error) {
  await stateManager.revert()
}
```

3. **Clear caches when memory usage is high**
```typescript
// Periodically clear caches
stateManager.clearCaches()
```

4. **Use proper error handling**
```typescript
try {
  await stateManager.getAccount(address)
} catch (error) {
  if (error instanceof AccountNotFoundError) {
    // Handle missing account
  }
  // Handle other errors
}
```

## Related Topics
- [EVM State Documentation](https://ethereum.org/en/developers/docs/evm/state)
- [Merkle Patricia Tree](https://ethereum.org/en/developers/docs/data-structures-and-encoding/patricia-merkle-trie)
- [Account Management](https://ethereum.org/en/developers/docs/accounts)