const std = @import("std");
const evm = @import("../../src/evm/evm.zig");
const Address = @import("../../src/address/address.zig");
const testing = std.testing;

// Test execution of SnailTracer contract to reproduce benchmark issue
// This test verifies that our EVM can execute the complex ray tracing contract
// that was failing in the benchmark suite
test "SnailTracer contract execution" {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    // SnailTracer bytecode from the benchmark (compiled with Solidity 0.4.26)
    // This is the same bytecode that was failing in the benchmark runner
    const snailtracer_bytecode_hex = "608060405234801561001057600080fd5b506144c8806100206000396000f3006080604052600436106100615763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166330627b7c811461006657806375ac892a146100bf578063784f13661461014f578063c29436011461016d575b600080fd5b34801561007257600080fd5b5061007b610185565b604080517fff000000000000000000000000000000000000000000000000000000000000009485168152928416602084015292168183015290519081900360600190f35b3480156100cb57600080fd5b506100da6004356024356129e9565b6040805160208082528351818301528351919283929083019185019080838360005b838110156101145781810151838201526020016100fc565b50505050905090810190601f1680156101415780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561015b57600080fd5b5061007b600435602435604435612c99565b34801561017957600080fd5b506100da600435612cd7565b6000806000806101936143c6565b61019b614428565b61040060009081556103006001556040805160e0810182526302faf08060808201908152630319750060a083015263119e7f8060c08301528152815160608101835292835261a67319602084810191909152620f423f1992840192909252919082019061020790612fa4565b815260006020808301829052604092830182905283518051600355808201516004558301516005558381015180516006559081015160075582015160085582820151600955606092830151600a805460ff1916911515919091179055815192830190915260015490548291906207d5dc0281151561028157fe5b058152600060208083018290526040928301919091528251600b81905583820151600c81905593830151600d819055835160608181018652928152808401959095528484015282519081018352600654815260075491810191909152600854918101919091526103139161030a91610301916102fc91613034565b612fa4565b6207d5dc6130a2565b620f42406130d5565b8051600e55602080820151600f55604091820151601055815160a08101835264174876e8008152825160608082018552641748862a40825263026e8f00828501526304dd1e008286015282840191825284518082018652600080825281860181905281870181905284870191825286518084018852620b71b081526203d0908188018190528189015292850192835260808501818152601180546001808201808455929094528751600b9091027f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c688101918255965180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c69890155808a01517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6a8901558a01517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6b880155935180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6c880155808901517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6d8801558901517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6e870155935180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6f870155968701517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7086015595909601517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7184015593517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7290920180549195939493909160ff19169083600281111561058d57fe5b0217905550505050601160a06040519081016040528064174876e800815260200160606040519081016040528064174290493f19815260200163026e8f0081526020016304dd1e0081525081526020016060604051908101604052806000815260200160008152602001600081525081526020016060604051908101604052806203d09081526020016203d0908152602001620b71b081525081526020016000600281111561063857fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156106d657fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200163026e8f00815260200164174876e8008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b081525081526020016000600281111561078057fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff191691849081111561081e57fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200163026e8f00815260200164173e54e97f198152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001600060028111156108c357fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff191691849081111561096157fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200164174876e80081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b0815250815260200160006002811115610a0b57fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610aa957fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200164174399c9ff1981526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b0815250815260200160006002811115610b5457fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610bf257fe5b0217905550505050601160a06040519081016040528062fbc520815260200160606040519081016040528063019bfcc0815260200162fbc52081526020016302cd29c08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115610c9857fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610d3657fe5b0217905550505050601160a0604051908101604052806323c3460081526020016060604051908101604052806302faf080815260200163289c455081526020016304dd1e00815250815260200160606040519081016040528062b71b00815260200162b71b00815260200162b71b00815250815260200160606040519081016040528060008152602001600081526020016000815250815260200160006002811115610dde57fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610e7c57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115610f9857fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561108557fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001600081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e5881525081526020016001600281111561119e57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561128b57fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156113a757fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561149457fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156115ad57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561169a57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156117b657fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156118a357fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156119bc57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff1916918490811115611aa957fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611bc557fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115611cb257fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611dcb57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115611eb857fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611fd457fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff19169184908111156120c157fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156121dd57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff19169184908111156122ca57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156123e657fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff19169184908111156124d357fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156125ef57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156126dc57fe5b0217905550505050600092505b6012548310156128af57601280548490811061270157fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff9091169081111561282257fe5b600281111561282d57fe5b8152505091506128626102fc61284b8460200151856000015161312c565b61285d8560400151866000015161312c565b613034565b601280548590811061287057fe5b906000526020600020906013020160090160008201518160000155602082015181600101556040820151816002015590505082806001019350506126e9565b6060604051908101604052806001546000546207d5dc028115156128cf57fe5b058152600060208083018290526040928301919091528251600b81905583820151600c81905593830151600d8190558351606081810186529281528084019590955284840152825190810183526006548152600754918101919091526008549181019190915261294a9161030a91610301916102fc91613034565b8051600e556020810151600f556040015160105561297781612972610200610180600861316b565b613326565b905061298d8161297261014561021c600861316b565b90506129a18161297261025880600861316b565b90506129b78161297261020a61020c600861316b565b90506129c48160046130d5565b8051602082015160409092015160f860020a9182029992820298500295509350505050565b606060006129f5614428565b600091505b600054821215612c0757612a0f82868661316b565b90506002816000015160f860020a0290808054603f811680603e8114612a5157600283018455600183161515612a43578192505b600160028404019350612a69565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612a905790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816020015160f860020a0290808054603f811680603e8114612af457600283018455600183161515612ae6578192505b600160028404019350612b0c565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612b335790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816040015160f860020a0290808054603f811680603e8114612b9757600283018455600183161515612b89578192505b600160028404019350612baf565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612bd65790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a840402179055505081806001019250506129fa565b6002805460408051602060018416156101000260001901909316849004601f81018490048402820184019092528181529291830182828015612c8a5780601f10612c5f57610100808354040283529160200191612c8a565b820191906000526020600020905b815481529060010190602001808311612c6d57829003601f168201915b50505050509250505092915050565b6000806000612ca6614428565b612cb187878761316b565b8051602082015160409092015160f860020a9182029a9282029950029650945050505050565b6060600080612ce4614428565b600180540392505b60008312612f1257600091505b600054821215612f0657612d0e82848761316b565b90506002816000015160f860020a0290808054603f811680603e8114612d5057600283018455600183161515612d42578192505b600160028404019350612d68565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612d8f5790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816020015160f860020a0290808054603f811680603e8114612df357600283018455600183161515612de5578192505b600160028404019350612e0b565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612e325790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816040015160f860020a0290808054603f811680603e8114612e9657600283018455600183161515612e88578192505b600160028404019350612eae565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612ed55790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550508180600101925050612cf9565b60001990920191612cec565b6002805460408051602060018416156101000260001901909316849004601f81018490048402820184019092528181529291830182828015612f955780601f10612f6a57610100808354040283529160200191612f95565b820191906000526020600020905b815481529060010190602001808311612f7857829003601f168201915b50505050509350505050919050565b612fac614428565b604082015160208301518351600092612fd2929180029180029190910190800201613364565b9050606060405190810160405280828560000151620f424002811515612ff457fe5b058152602001828560200151620f42400281151561300e57fe5b058152602001828560400151620f42400281151561302857fe5b05905291505b50919050565b61303c614428565b60606040519081016040528083602001518560400151028460400151866020015102038152602001836040015185600001510284600001518660400151020381526020018360000151856020015102846020015186600001510203815250905092915050565b6130aa614428565b5060408051606081018252835183028152602080850151840290820152928101519091029082015290565b6130dd614428565b6060604051908101604052808385600001518115156130f857fe5b05815260200183856020015181151561310d57fe5b05815260200183856040015181151561312257fe5b0590529392505050565b613134614428565b5060408051606081018252825184510381526020808401518186015103908201528282015184830151039181019190915292915050565b613173614428565b600061317d614428565b61318561444a565b6000546013805463ffffffff1916918802890163ffffffff169190911790556131ac614428565b9350600092505b848312156133055760408051606081018252600b548152600c546020820152600d5491810191909152600054613287916132619161030a9161322a916207a12090816131fd613399565b63ffffffff1681151561320c57fe5b0663ffffffff168e620f4240020181151561322357fe5b05036130a2565b60408051606081018252600e548152600f5460208201526010549181019190915260015461297291906207a12090816131fd613399565b604080516060810182526006548152600754602082015260085491810191909152613326565b6040805160e081019091526003546080820190815260045460a083015260055460c08301529193509081906132c19061297286608c6130a2565b81526020016132cf84612fa4565b815260006020820181905260409091015290506132f8846129726132f2846133c2565b886130d5565b93506001909201916131b3565b61331b61030a613314866137af565b60ff6130a2565b979650505050505050565b61332e614428565b50604080516060810182528251845101815260208084015181860151019082015291810151928101519092019181019190915290565b80600260018201055b8181121561302e57809150600281828581151561338657fe5b050181151561339157fe5b05905061336d565b6013805463ffffffff19811663ffffffff9182166341c64e6d0261303901821617918290551690565b6133ca614428565b60008060006133d7614480565b6133df6143c6565b6133e7614428565b6133ef614428565b60006133f9614428565b600a8b60400151131561342c576060604051908101604052806000815260200160008152602001600081525099506137a1565b6134358b6137fe565b919a5098509650881515613469576060604051908101604052806000815260200160008152602001600081525099506137a1565b600088600181111561347757fe5b141561356757601180548890811061348b57fe5b60009182526020918290206040805160a081018252600b90930290910180548352815160608181018452600183015482526002808401548388015260038401548386015285870192909252835180820185526004840154815260058401548188015260068401548186015285850152835180820185526007840154815260088401549681019690965260098301549386019390935291830193909352600a830154919291608084019160ff9091169081111561354357fe5b600281111561354e57fe5b81525050955085606001519350856040015192506136b6565b601280548890811061357557fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff9091169081111561369657fe5b60028111156136a157fe5b8152505094508460a001519350846080015192505b6001915081846040015113156136ce57836040015191505b81846020015113156136e257836020015191505b81846040015113156136f657836040015191505b60408b01805160010190819052600512156137595781620f4240613718613399565b63ffffffff1681151561372757fe5b0663ffffffff1612156137515761374a61374485620f42406130a2565b836130d5565b9350613759565b8299506137a1565b600088600181111561376757fe5b141561377f576137788b878b613abc565b905061378d565b61378a8b868b613b64565b90505b61379e8361297261030a8785613c34565b99505b505050505050505050919050565b6137b7614428565b6060604051908101604052806137d08460000151613c72565b81526020016137e28460200151613c72565b81526020016137f48460400151613c72565b905290505b919050565b6000808080808080805b601154821015613924576138f060118381548110151561382457fe5b60009182526020918290206040805160a081018252600b90930290910180548352815160608181018452600183015482526002808401548388015260038401548386015285870192909252835180820185526004840154815260058401548188015260068401548186015285850152835180820185526007840154815260088401549681019690965260098301549386019390935291830193909352600a830154919291608084019160ff909116908111156138dc57fe5b60028111156138e757fe5b9052508a613c9d565b9050600081138015613909575084158061390957508481125b1561391957809450600093508192505b600190910190613808565b600091505b601254821015613aae57613a7a60128381548110151561394557fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff90911690811115613a6657fe5b6002811115613a7157fe5b9052508a613d";

    // Convert hex string to binary bytes
    const bytecode_binary = try allocator.alloc(u8, snailtracer_bytecode_hex.len / 2);
    defer allocator.free(bytecode_binary);
    _ = try std.fmt.hexToBytes(bytecode_binary, snailtracer_bytecode_hex);

    std.debug.print("Compiled SnailTracer bytecode length: {} bytes\n", .{bytecode_binary.len});

    // Initialize memory database
    var memory_db = evm.MemoryDatabase.init(allocator);
    defer memory_db.deinit();
    const db_interface = memory_db.to_database_interface();

    // Initialize VM
    var vm = evm.Vm.init(allocator, db_interface, null, null) catch |err| {
        std.debug.print("Failed to initialize VM: {}\n", .{err});
        return err;
    };
    defer vm.deinit();

    // Contract addresses
    const CREATOR_ADDRESS: [20]u8 = [_]u8{0x10} ++ [_]u8{0x00} ** 19;
    const CALLER_ADDRESS: [20]u8 = [_]u8{0x30} ++ [_]u8{0x00} ** 19;
    const GAS_LIMIT: u64 = std.math.maxInt(u64);

    // Set up creator account with sufficient balance
    try vm.state.set_balance(CREATOR_ADDRESS, std.math.maxInt(u256));

    std.debug.print("Deploying SnailTracer contract...\n", .{});

    // Deploy the contract
    const create_result = vm.create_contract(
        CREATOR_ADDRESS, // creator
        0, // value
        bytecode_binary, // init code
        GAS_LIMIT, // gas
    ) catch |err| {
        std.debug.print("Failed to deploy contract: {}\n", .{err});
        return err;
    };

    std.debug.print("Create result: success={}\n", .{create_result.success});

    if (!create_result.success) {
        std.debug.print("Contract deployment failed\n", .{});
        return error.DeploymentFailed;
    }

    const contract_addr = create_result.address;
    std.debug.print("Deployed contract to address: {any}\n", .{contract_addr});

    // Check if code was actually deployed
    const deployed_code = vm.state.get_code(contract_addr);
    std.debug.print("Deployed code length: {}\n", .{deployed_code.len});

    // Set up caller account
    try vm.state.set_balance(CALLER_ADDRESS, std.math.maxInt(u256));

    // Prepare calldata for Benchmark() function
    // Function selector: 30627b7c (first 4 bytes of keccak256("Benchmark()"))
    const benchmark_calldata = [_]u8{ 0x30, 0x62, 0x7b, 0x7c };

    std.debug.print("Calling Benchmark() function...\n", .{});

    // Create a contract instance for execution
    var contract = evm.Contract.init(
        CALLER_ADDRESS, // caller
        contract_addr, // address
        0, // value
        GAS_LIMIT, // gas
        deployed_code, // code
        [_]u8{0} ** 32, // code_hash (not used for execution)
        &benchmark_calldata, // input
        false, // is_static
    );
    defer contract.deinit(vm.allocator, null);

    const start_time = std.time.nanoTimestamp();

    const run_result = vm.interpret(&contract, &benchmark_calldata) catch |err| {
        std.debug.print("Contract interpretation failed: {}\n", .{err});
        return err;
    };

    const end_time = std.time.nanoTimestamp();
    const execution_time_ns = end_time - start_time;
    const execution_time_ms = @as(f64, @floatFromInt(execution_time_ns)) / 1_000_000.0;

    std.debug.print("Execution completed in {d:.2} ms\n", .{execution_time_ms});

    // Check execution result
    switch (run_result.status) {
        .Success => {
            std.debug.print("✅ Contract execution succeeded!\n", .{});
            std.debug.print("Return data length: {}\n", .{run_result.return_data.len});
            
            // The Benchmark() function should return 3 bytes (r, g, b)
            if (run_result.return_data.len >= 3) {
                const r = run_result.return_data[0];
                const g = run_result.return_data[1]; 
                const b = run_result.return_data[2];
                std.debug.print("Ray traced RGB result: r={}, g={}, b={}\n", .{ r, g, b });
            }
        },
        .Revert => {
            std.debug.print("❌ Contract execution reverted\n", .{});
            if (run_result.return_data.len > 0) {
                std.debug.print("Revert data: {any}\n", .{run_result.return_data});
            }
            return error.TestFailed;
        },
        else => {
            std.debug.print("❌ Contract execution failed with status: {}\n", .{run_result.status});
            return error.TestFailed;
        },
    }

    std.debug.print("Gas used: {}\n", .{GAS_LIMIT - run_result.gas_remaining});
}

// Test a simpler call to verify basic contract functionality
test "SnailTracer simple function call" {
    var gpa = std.heap.GeneralPurposeAllocator(.{}){};
    defer _ = gpa.deinit();
    const allocator = gpa.allocator();

    // Same bytecode as above
    const snailtracer_bytecode_hex = "608060405234801561001057600080fd5b506144c8806100206000396000f3006080604052600436106100615763ffffffff7c010000000000000000000000000000000000000000000000000000000060003504166330627b7c811461006657806375ac892a146100bf578063784f13661461014f578063c29436011461016d575b600080fd5b34801561007257600080fd5b5061007b610185565b604080517fff000000000000000000000000000000000000000000000000000000000000009485168152928416602084015292168183015290519081900360600190f35b3480156100cb57600080fd5b506100da6004356024356129e9565b6040805160208082528351818301528351919283929083019185019080838360005b838110156101145781810151838201526020016100fc565b50505050905090810190601f1680156101415780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34801561015b57600080fd5b5061007b600435602435604435612c99565b34801561017957600080fd5b506100da600435612cd7565b6000806000806101936143c6565b61019b614428565b61040060009081556103006001556040805160e0810182526302faf08060808201908152630319750060a083015263119e7f8060c08301528152815160608101835292835261a67319602084810191909152620f423f1992840192909252919082019061020790612fa4565b815260006020808301829052604092830182905283518051600355808201516004558301516005558381015180516006559081015160075582015160085582820151600955606092830151600a805460ff1916911515919091179055815192830190915260015490548291906207d5dc0281151561028157fe5b058152600060208083018290526040928301919091528251600b81905583820151600c81905593830151600d819055835160608181018652928152808401959095528484015282519081018352600654815260075491810191909152600854918101919091526103139161030a91610301916102fc91613034565b612fa4565b6207d5dc6130a2565b620f42406130d5565b8051600e55602080820151600f55604091820151601055815160a08101835264174876e8008152825160608082018552641748862a40825263026e8f00828501526304dd1e008286015282840191825284518082018652600080825281860181905281870181905284870191825286518084018852620b71b081526203d0908188018190528189015292850192835260808501818152601180546001808201808455929094528751600b9091027f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c688101918255965180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c69890155808a01517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6a8901558a01517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6b880155935180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6c880155808901517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6d8801558901517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6e870155935180517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c6f870155968701517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7086015595909601517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7184015593517f31ecc21a745e3968a04e9570e4425bc18fa8019c68028196b546d1669c200c7290920180549195939493909160ff19169083600281111561058d57fe5b0217905550505050601160a06040519081016040528064174876e800815260200160606040519081016040528064174290493f19815260200163026e8f0081526020016304dd1e0081525081526020016060604051908101604052806000815260200160008152602001600081525081526020016060604051908101604052806203d09081526020016203d0908152602001620b71b081525081526020016000600281111561063857fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156106d657fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200163026e8f00815260200164174876e8008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b081525081526020016000600281111561078057fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff191691849081111561081e57fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200163026e8f00815260200164173e54e97f198152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001600060028111156108c357fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff191691849081111561096157fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200164174876e80081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b0815250815260200160006002811115610a0b57fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610aa957fe5b0217905550505050601160a06040519081016040528064174876e80081526020016060604051908101604052806302faf080815260200164174399c9ff1981526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620b71b08152602001620b71b08152602001620b71b0815250815260200160006002811115610b5457fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610bf257fe5b0217905550505050601160a06040519081016040528062fbc520815260200160606040519081016040528063019bfcc0815260200162fbc52081526020016302cd29c08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115610c9857fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610d3657fe5b0217905550505050601160a0604051908101604052806323c3460081526020016060604051908101604052806302faf080815260200163289c455081526020016304dd1e00815250815260200160606040519081016040528062b71b00815260200162b71b00815260200162b71b00815250815260200160606040519081016040528060008152602001600081526020016000815250815260200160006002811115610dde57fe5b90528154600181810180855560009485526020948590208451600b90940201928355848401518051848401558086015160028086019190915560409182015160038601558186015180516004870155808801516005870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115610e7c57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115610f9857fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561108557fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001600081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e5881525081526020016001600281111561119e57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561128b57fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156113a757fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561149457fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156115ad57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600886015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff191691849081111561169a57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156117b657fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156118a357fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156119bc57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff1916918490811115611aa957fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280630459e44081526020016302f34f6081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611bc557fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115611cb257fe5b0217905550505050601260e060405190810160405280606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001600081526020016304dd1e008152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611dcb57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff1916918490811115611eb857fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016303aa6a608152508152602001606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e58815250815260200160016002811115611fd457fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600987015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff19169184908111156120c157fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f208152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630555a9608152602001630188c2e081526020016304a62f808152508152602001606060405190810160405280630459e4408152602001630188c2e081526020016305a1f4a08152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156121dd57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015580880151600a870155820151600b86015560808601518051600c87015580880151600d870155820151600e86015560a08601518051600f870155968701516010860155950151601184015560c084015160128401805492969193909260ff19169184908111156122ca57fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016303aa6a608152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156123e657fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156124d357fe5b0217905550505050601260e06040519081016040528060606040519081016040528063035e1f20815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280630459e440815260200163016a8c8081526020016305a1f4a08152508152602001606060405190810160405280630555a960815260200163016a8c8081526020016304a62f808152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280600081526020016000815260200160008152508152602001606060405190810160405280620f3e588152602001620f3e588152602001620f3e588152508152602001600160028111156125ef57fe5b90528154600181810180855560009485526020948590208451805160139095029091019384558086015184840155604090810151600280860191909155868601518051600387015580880151600487015582015160058601558186015180516006870155808801516007870155820151600686015560608601518051600787015596870151600886015595015160098401556080840151600a8401805492969193909260ff19169184908111156126dc57fe5b0217905550505050600092505b6012548310156128af57601280548490811061270157fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff9091169081111561282257fe5b600281111561282d57fe5b8152505091506128626102fc61284b8460200151856000015161312c565b61285d8560400151866000015161312c565b613034565b601280548590811061287057fe5b906000526020600020906013020160090160008201518160000155602082015181600101556040820151816002015590505082806001019350506126e9565b6060604051908101604052806001546000546207d5dc028115156128cf57fe5b058152600060208083018290526040928301919091528251600b81905583820151600c81905593830151600d8190558351606081810186529281528084019590955284840152825190810183526006548152600754918101919091526008549181019190915261294a9161030a91610301916102fc91613034565b8051600e556020810151600f556040015160105561297781612972610200610180600861316b565b613326565b905061298d8161297261014561021c600861316b565b90506129a18161297261025880600861316b565b90506129b78161297261020a61020c600861316b565b90506129c48160046130d5565b8051602082015160409092015160f860020a9182029992820298500295509350505050565b606060006129f5614428565b600091505b600054821215612c0757612a0f82868661316b565b90506002816000015160f860020a0290808054603f811680603e8114612a5157600283018455600183161515612a43578192505b600160028404019350612a69565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612a905790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816020015160f860020a0290808054603f811680603e8114612af457600283018455600183161515612ae6578192505b600160028404019350612b0c565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612b335790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816040015160f860020a0290808054603f811680603e8114612b9757600283018455600183161515612b89578192505b600160028404019350612baf565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612bd65790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a840402179055505081806001019250506129fa565b6002805460408051602060018416156101000260001901909316849004601f81018490048402820184019092528181529291830182828015612c8a5780601f10612c5f57610100808354040283529160200191612c8a565b820191906000526020600020905b815481529060010190602001808311612c6d57829003601f168201915b50505050509250505092915050565b6000806000612ca6614428565b612cb187878761316b565b8051602082015160409092015160f860020a9182029a9282029950029650945050505050565b6060600080612ce4614428565b600180540392505b60008312612f1257600091505b600054821215612f0657612d0e82848761316b565b90506002816000015160f860020a0290808054603f811680603e8114612d5057600283018455600183161515612d42578192505b600160028404019350612d68565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612d8f5790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816020015160f860020a0290808054603f811680603e8114612df357600283018455600183161515612de5578192505b600160028404019350612e0b565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612e325790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550506002816040015160f860020151600040015160f860020a0290808054603f811680603e8114612e9657600283018455600183161515612e88578192505b600160028404019350612eae565b600084815260209081902060ff198516905560419094555b5050509060018203815460011615612ed55790600052602060002090602091828204019190065b90919290919091601f036101000a81548160ff0219169060f860020a84040217905550508180600101925050612cf9565b60001990920191612cec565b6002805460408051602060018416156101000260001901909316849004601f81018490048402820184019092528181529291830182828015612f955780601f10612f6a57610100808354040283529160200191612f95565b820191906000526020600020905b815481529060010190602001808311612f7857829003601f168201915b50505050509350505050919050565b612fac614428565b604082015160208301518351600092612fd2929180029180029190910190800201613364565b9050606060405190810160405280828560000151620f424002811515612ff457fe5b058152602001828560200151620f42400281151561300e57fe5b058152602001828560400151620f42400281151561302857fe5b05905291505b50919050565b61303c614428565b60606040519081016040528083602001518560400151028460400151866020015102038152602001836040015185600001510284600001518660400151020381526020018360000151856020015102846020015186600001510203815250905092915050565b6130aa614428565b5060408051606081018252835183028152602080850151840290820152928101519091029082015290565b6130dd614428565b6060604051908101604052808385600001518115156130f857fe5b05815260200183856020015181151561310d57fe5b05815260200183856040015181151561312257fe5b0590529392505050565b613134614428565b5060408051606081018252825184510381526020808401518186015103908201528282015184830151039181019190915292915050565b613173614428565b600061317d614428565b61318561444a565b6000546013805463ffffffff1916918802890163ffffffff169190911790556131ac614428565b9350600092505b848312156133055760408051606081018252600b548152600c546020820152600d5491810191909152600054613287916132619161030a9161322a916207a12090816131fd613399565b63ffffffff1681151561320c57fe5b0663ffffffff168e620f4240020181151561322357fe5b05036130a2565b60408051606081018252600e548152600f5460208201526010549181019190915260015461297291906207a12090816131fd613399565b604080516060810182526006548152600754602082015260085491810191909152613326565b6040805160e081019091526003546080820190815260045460a083015260055460c08301529193509081906132c19061297286608c6130a2565b81526020016132cf84612fa4565b815260006020820181905260409091015290506132f8846129726132f2846133c2565b886130d5565b93506001909201916131b3565b61331b61030a613314866137af565b60ff6130a2565b979650505050505050565b61332e614428565b50604080516060810182528251845101815260208084015181860151019082015291810151928101519092019181019190915290565b80600260018201055b8181121561302e57809150600281828581151561338657fe5b050181151561339157fe5b05905061336d565b6013805463ffffffff19811663ffffffff9182166341c64e6d0261303901821617918290551690565b6133ca614428565b60008060006133d7614480565b6133df6143c6565b6133e7614428565b6133ef614428565b60006133f9614428565b600a8b60400151131561342c576060604051908101604052806000815260200160008152602001600081525099506137a1565b6134358b6137fe565b919a5098509650881515613469576060604051908101604052806000815260200160008152602001600081525099506137a1565b600088600181111561347757fe5b141561356757601180548890811061348b57fe5b60009182526020918290206040805160a081018252600b90930290910180548352815160608181018452600183015482526002808401548388015260038401548386015285870192909252835180820185526004840154815260058401548188015260068401548186015285850152835180820185526007840154815260088401549681019690965260098301549386019390935291830193909352600a830154919291608084019160ff9091169081111561354357fe5b600281111561354e57fe5b81525050955085606001519350856040015192506136b6565b601280548890811061357557fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff9091169081111561369657fe5b60028111156136a157fe5b8152505094508460a001519350846080015192505b6001915081846040015113156136ce57836040015191505b81846020015113156136e257836020015191505b81846040015113156136f657836040015191505b60408b01805160010190819052600512156137595781620f4240613718613399565b63ffffffff1681151561372757fe5b0663ffffffff1612156137515761374a61374485620f42406130a2565b836130d5565b9350613759565b8299506137a1565b600088600181111561376757fe5b141561377f576137788b878b613abc565b905061378d565b61378a8b868b613b64565b90505b61379e8361297261030a8785613c34565b99505b505050505050505050919050565b6137b7614428565b6060604051908101604052806137d08460000151613c72565b81526020016137e28460200151613c72565b81526020016137f48460400151613c72565b905290505b919050565b6000808080808080805b601154821015613924576138f060118381548110151561382457fe5b60009182526020918290206040805160a081018252600b90930290910180548352815160608181018452600183015482526002808401548388015260038401548386015285870192909252835180820185526004840154815260058401548188015260068401548186015285850152835180820185526007840154815260088401549681019690965260098301549386019390935291830193909352600a830154919291608084019160ff909116908111156138dc57fe5b60028111156138e757fe5b9052508a613c9d565b9050600081138015613909575084158061390957508481125b1561391957809450600093508192505b600190910190613808565b600091505b601254821015613aae57613a7a60128381548110151561394557fe5b600091825260209182902060408051610140810182526013909302909101805460e08401908152600182015461010085015260028083015461012086015290845282516060818101855260038401548252600484015482880152600584015482860152858701919091528351808201855260068401548152600784015481880152600884015481860152858501528351808201855260098401548152600a84015481880152600b840154818601528186015283518082018552600c8401548152600d84015481880152600e84015481860152608086015283519081018452600f830154815260108301549581019590955260118201549285019290925260a0830193909352601283015491929160c084019160ff90911690811115613a6657fe5b6002811115613a7157fe5b9052508a613c9d";

    // For testing, let's try a shorter contract deployment to check if our deployment logic works
    // This is just a minimal constructor that returns a simple value
    const minimal_bytecode_hex = "6080604052348015600f57600080fd5b50600080fd";

    const bytecode_binary = try allocator.alloc(u8, minimal_bytecode_hex.len / 2);
    defer allocator.free(bytecode_binary);
    _ = try std.fmt.hexToBytes(bytecode_binary, minimal_bytecode_hex);

    std.debug.print("Minimal test bytecode length: {} bytes\n", .{bytecode_binary.len});

    // Initialize memory database
    var memory_db = evm.MemoryDatabase.init(allocator);
    defer memory_db.deinit();
    const db_interface = memory_db.to_database_interface();

    // Initialize VM
    var vm = evm.Vm.init(allocator, db_interface, null, null) catch |err| {
        std.debug.print("Failed to initialize VM: {}\n", .{err});
        return err;
    };
    defer vm.deinit();

    // Contract addresses
    const CREATOR_ADDRESS: [20]u8 = [_]u8{0x10} ++ [_]u8{0x00} ** 19;
    const GAS_LIMIT: u64 = 1000000;

    // Set up creator account with sufficient balance
    try vm.state.set_balance(CREATOR_ADDRESS, std.math.maxInt(u256));

    std.debug.print("Deploying minimal test contract...\n", .{});

    // Deploy the minimal contract
    const create_result = vm.create_contract(
        CREATOR_ADDRESS, // creator
        0, // value
        bytecode_binary, // init code
        GAS_LIMIT, // gas
    ) catch |err| {
        std.debug.print("Failed to deploy contract: {}\n", .{err});
        return err;
    };

    std.debug.print("Minimal contract deployment result: success={}\n", .{create_result.success});

    // This test verifies our deployment mechanism works
    if (create_result.success) {
        std.debug.print("✅ Basic contract deployment works!\n", .{});
    } else {
        std.debug.print("❌ Basic contract deployment failed\n", .{});
        return error.TestFailed;
    }
}